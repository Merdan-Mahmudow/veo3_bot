# ТЗ: Реферальная и партнёрская программа для ОБЪЕКТИVEO 3 (Telegram‑бот)

**Версия:** 1.0  
**Дата:** 27.09.2025  
**Автор:** Махмудов Мердан

---

## 0. Краткое резюме
Реализовать в Telegram‑боте ОБЪЕКТИVEO 3 реферальную и партнёрскую программу с тремя ролями: **user**, **partner**, **admin**. Каждый новый аккаунт получает личную реферальную ссылку. **Admin** может повышать **user** до **partner** и/или назначать роль **admin**.

**Основное:**
- Регистрация по реферальной ссылке фиксирует **источник**: от **user** или **partner**.
- При первой покупке приглашённого **user** (если его пригласил **user**): обеим сторонам выдаётся **1 генерация (coin)**.
- Если **user** приглашён **partner**’ом: начисляется **денежная комиссия партнёру** по проценту, привязанному к ссылке партнёра (10/20/30/40/50%). Для разных ссылок одного партнёра может быть **разный процент**.
- Начисления партнёрам ведутся в отдельном учёте (баланс, запросы на выплату, статусы).
- В боте доступен **кабинет партнёра** (статистика, история, запросы на новые ссылки/выплаты) и **инструменты админа** (статистика, управление ролями, условиями и выгрузки).
- Ежедневные/еженедельные отчёты доступны в кабинете партнёра и агрегированно — администратору.

---

## 1. Термины и определения
- **Генерация / coin** — внутренняя единица (бонус), пополняющая баланс генераций пользователя.
- **Покупка** — оплата наборов генераций любым из подключённых платёжных методов.
- **Реферальная ссылка** — deep‑link Telegram формата `https://t.me/<bot>?start=<payload>`, где payload — подписанный токен.
- **Источник (атрибуция)** — первый реферер, зафиксированный при старте с payload: `type=user|partner`, `ref_id`, `link_id`.
- **Партнёрская ссылка** — реф. ссылка, привязанная к партнёру с фиксированным процентом вознаграждения.
- **Комиссия** — денежное вознаграждение партнёру от покупок его рефералов (по его ссылке).
- **Кабинет партнёра** — раздел бота с метриками, историей начислений, заявками на выплаты и создание новых ссылок.
- **Админ‑панель (в боте)** — раздел бота для управления ролями, ссылками, ставками и отчётностью.

---

## 2. Роли и права доступа
### 2.1 user
- Имеет личную реферальную ссылку (по умолчанию создаётся при регистрации).
- Может приглашать друзей.
- Получает **1 coin** после **первой** оплаты приглашённого друга (и другу — **1 coin**).
- Видит свой баланс генераций и историю бонусов.

### 2.2 partner
- Имеет **одну или несколько** партнёрских ссылок с указанным процентом (10/20/30/40/50%).
- Получает денежную комиссию от покупок пользователей, зарегистрированных **по его партнёрским ссылкам**.
- Имеет кабинет: метрики (регистрации, оплаты, сумма комиссий), количество бонус‑генераций, начисленных его рефералам, история начислений, запросы на выплаты, запросы на новые ссылки.

### 2.3 admin
- Может назначать/снимать роли **admin** и **partner** у существующих пользователей.
- Может создавать/редактировать партнёрские ссылки, задавать процент (10–50, шаг 10).
- Видит общую статистику, выгружает отчёты.
- Подтверждает/отклоняет выплаты партнёрам, настраивает условия и параметры программы.

Матрица прав — см. §14.

---

## 3. Бизнес‑правила и атрибуция
### 3.1 Генерация реферальных ссылок
- **User‑ссылка** создаётся автоматически при регистрации: одна постоянная ссылка на пользователя (`link_type=user`).
- **Partner‑ссылки** создаёт админ (или по заявке партнёра): одна или несколько на партнёра с полем **percent ∈ {10,20,30,40,50}** (`link_type=partner`).
- Payload должен быть **подписан** (HMAC + exp/nonce) для защиты от подмены.

### 3.2 Атрибуция при регистрации
- Если пользователь стартует бота с `start=<payload>`, фиксируем **источник** в профиле: `referrer_type` (user|partner), `referrer_id` (id владельца), `ref_link_id` (конкретная ссылка).
- Атрибуция **не меняется** автоматически после регистрации. Изменение возможно **только админом** (ручная корректировка с записью в журнал аудита).
- В случае повторных стартов/кликов по другим ссылкам после регистрации — **игнорировать** для атрибуции.

### 3.3 Бонусы «user → user»
- Триггер: **первая покупка** приглашённого.
- Начисление: +1 coin **пригласившему** и +1 coin **покупателю**.
- Гарантии:
  - Срабатывает **один раз** на пару «пригласивший ↔ приглашённый».
  - Идемпотентность по `purchase_id`.
  - Если приглашённый пришёл по ссылке **partner**, бонусы **не применяются**.

### 3.4 Комиссии «partner → user»
- Каждая покупка пользователя, пришедшего по партнёрской ссылке, генерирует комиссию партнёру.
- Процент берётся из **ссылки**, по которой зарегистрирован пользователь (персистится на момент регистрации).
- Комиссия считается от **суммы к зачёту** (см. §8.3: валюта, комиссии платёжек, скидки/купоны).
- Комиссии попадают в **баланс партнёра** со статусом `accrued`.
- Бонус‑coins при этой схеме **не** начисляются ни партнёру, ни пользователю по факту приглашения.

### 3.5 Множественные ссылки партнёра
- Партнёр может иметь несколько ссылок с разными процентами (для разных каналов/кампаний).
- Процент зашит в `ref_link_id` → неизменяем для уже зарегистрированных пользователей.

### 3.6 Возвраты/отмены
- При возврате платежа выполняем **реверс комиссии** партнёра (минус к балансу) и, если начислялись бонус‑coins (в схеме «user→user»), выполняем **сторно бонусов** (минус с обеих сторон), если возврат относится к **первой покупке**.

---

## 4. Пользовательские сценарии (сквозные)
### 4.1 Регистрация по ссылке user
1) Новый пользователь кликает `user`‑ссылку.  
2) Бот фиксирует атрибуцию `referrer_type=user`.  
3) Пользователь завершает онбординг.  
4) При первой покупке: оба получают по **1 coin**.  
5) В профилях фиксируются записи в **ledger бонусов**.

### 4.2 Регистрация по ссылке partner
1) Новый пользователь кликает `partner`‑ссылку.  
2) Бот фиксирует `referrer_type=partner`, `percent` из ссылки.  
3) Любая покупка пользователя: партнёру начисляется комиссия в соответствии с процентом ссылки.  
4) Партнёр видит начисления и рост баланса в кабинете.

### 4.3 Админ выдаёт роль partner
1) Админ открывает карточку пользователя.  
2) Нажимает «Выдать роль партнёра».  
3) Создаёт хотя бы одну партнёрскую ссылку с процентом.  
4) Пользователь получает доступ в кабинет партнёра.

### 4.4 Партнёр запрашивает новую ссылку
1) В кабинете выбирает «Новая ссылка».  
2) Выбирает процент (10/20/30/40/50) и указывает комментарий/канал.  
3) Заявка уходит админу → админ **подтверждает** → ссылка появляется у партнёра.

### 4.5 Партнёр запрашивает выплату
1) В кабинете нажимает «Запросить выплату», указывает сумму ≤ доступного баланса и реквизиты.  
2) Создаётся заявка `payout_request` → статус `requested`.  
3) Админ проверяет и переводит в `approved|rejected`.  
4) При `approved` после фактического перевода админ помечает `paid` (с фиксацией транзакции/чека).  
5) Баланс партнёра уменьшается на выплаченную сумму; запись в **ledger выплат**.

---

### 5.2 Экран «Моя реф. ссылка» (user)
- Кнопка «Скопировать ссылку», «Поделиться».  
- Плашки: «Пригласи друга — после его **первой покупки** вы оба получите **1 генерацию**».
- Виджет статистики: кол-во переходов, регистраций по ссылке, сколько друзей совершили первую покупку, сколько бонусов начислено.

### 5.3 Кабинет партнёра
Разделы:
- **Дашборд**:
  - Регистрации по всем его ссылкам (за сегодня/неделю/всё время).
  - Оплаты: кол-во и суммарная сумма.
  - Начисленные комиссии (за периоды).
  - Сколько бонус‑генераций начислено его рефералам (см. §7.1 метрика D5).
  - Баланс и кнопка «Запросить выплату».
- **Мои ссылки**: таблица (название/комментарий, процент, дата создания, переходы, регистрации, оплаты, выручка, комиссия). Кнопка «Новая ссылка» (заявка → админу).
- **История начислений**: список транзакций комиссий (дата, пользователь, покупка, сумма к зачёту, %, комиссия, статус).
- **Выплаты**: история заявок (id, сумма, статус, дата, реквизиты).
- **Отчёты**: кнопки «Ежедневный», «Еженедельный» (см. §7).

### 5.4 Админ‑панель
Разделы:
- **Пользователи**: поиск, карточка, назначение ролей (user/partner/admin), просмотр атрибуции и источника.
- **Партнёры**: список, баланс, ссылки, создать/редактировать ссылку с процентом, просмотреть историю комиссий и выплат.
- **Заявки**: на ссылки (approve/reject), на выплаты (approve/reject/mark paid).
- **Отчёты**: сводка за день/неделю/периоды, выгрузка CSV.
- **Настройки программы**:
  - Диапазон процентов (фикс: 10,20,30,40,50).
  - База расчёта комиссий (gross/net).
  - Порог минимальной выплаты (напр., 1000 ₽).
  - Таймзона отчётов (по умолчанию Europe/Moscow).
  - Политика сторно при возвратах.

---

## 6. Отчёты и статистика
### 6.1 Периоды
- **Ежедневный**: последние полные 24 часа по таймзоне проекта.
- **Еженедельный**: последние полные 7 дней (Пн–Вс, конфигурируемо).

### 6.2 Метрики (для партнёра)
- D1: Количество **регистраций** по его ссылкам.
- D2: Количество **оплат** рефералов.
- D3: **Сумма к зачёту** (оборот по рефералам, база для комиссии).
- D4: **Сумма начисленных комиссий**.
- D5: **Сколько бонус‑генераций начислено его рефералам** (информативно, монетарно не влияет).
- D6: **Конверсия** регистраций в оплату.
- D7: Средний чек.

### 6.3 Метрики (для админа)
- A1: Регистрации/оплаты по всем партнёрам.
- A2: Начислено комиссий всего/по партнёрам/по ссылкам.
- A3: Бонусные генерации, розданные по схеме «user→user».
- A4: Выплаты партнёрам: начислено, запрошено, выплачено, остатки.
- A5: Воронка и эффективность ссылок (CTR, CR регистрация→оплата).

### 6.4 Выгрузки
- CSV: партнёрские начисления за период; заявки на выплаты; агрегации по ссылкам.
- Форматы: UTF‑8, `;` как разделитель, десятичный `,` (конфигурируемо).

---

## 7. Учёт, деньги и бонусы
### 7.1 Валюта и налоги
- Внутренний расчёт в **рублях** (или базовой валюте проекта); хранить точные суммы в **копейках/центах** (целое).
- Отображение — с форматированием и округлением банковским правилом.

### 7.2 Базы расчёта
- **Сумма к зачёту** = оплаченная сумма **после** скидок/купонных уменьшений, **до** вычета платёжной комиссии (конфигурируемо, может быть и net‑после комиссии).
- Комиссия партнёра = `Сумма к зачёту × (percent/100)`.

### 7.3 Леджеры
- **partner_commission_ledger**: accrual/storno/adjustment; поля: `partner_id, user_id, purchase_id, ref_link_id, base_amount, percent, commission_amount, status, reason, created_at`.
- **partner_balance**: текущее сальдо (агрегат леджера − выплаты).
- **payouts**: заявки и факты выплат (`requested, approved, rejected, paid`).
- **coin_bonus_ledger**: `giver_id, receiver_id, purchase_id, coins=1, status, created_at`.

### 7.4 Возвраты/сторно
- При возврате платежа создаётся запись `storno` с отрицательной суммой комиссии и корректировкой баланса.
- Если возврат относится к **первой покупке** в схеме user→user, выполняется отрицательное начисление `coins=-1` обеим сторонам (если баланс позволяет; иначе — оставить **отрицательный** остаток бонус‑счёта до компенсации будущими начислениями или запретить минус — конфиг).

---

## 8. Антифрод и ограничения
- **Запрет само‑реферала**: совпадение `telegram_user_id`/устройства/платёжного инструмента — флаг «подозрительно» → ручная проверка админом.
- **Лимиты**: макс. N регистраций/сутки с одного устройства/IP (конфиг).
- **Задержка выплат**: холд X дней для новых заказов до доступности к выводу (по умолчанию 7 дней).
- **Черные списки**: по пользователям/партнёрам/платежным реквизитам.
- **Журнал аудита** всех критичных действий (назначение ролей, изменение атрибуции, ручные корректировки, выплаты).

---

## 9. Нефункциональные требования
- **Идемпотентность** всех начислений по `purchase_id`/`pair(user, inviter)`.
- **Производительность**: обработка события оплаты ≤ 500 мс (без внешних платёжных запросов).
- **Надёжность**: повторная обработка webhook’ов — безопасна (idempotency keys).
- **Безопасность**: HMAC для payload, ограничение времени действия, валидация подписи.
- **Логи/мониторинг**: метрики Prometheus: начисления/мин, ошибки, сторно, баланс расхождений.

---

## 10. API/Ивенты (примерный контракт)
### 10.1 События (event bus)
- `payment.succeeded {user_id, purchase_id, amount_minor, currency, ts}`
- `payment.refunded {user_id, purchase_id, amount_minor, ts}`
- `referral.registered {new_user_id, referrer_type, referrer_id, ref_link_id, ts}`
- `payout.requested {partner_id, amount_minor, requisites, ts}`
- `payout.status_changed {payout_id, status, ts}`

### 10.2 Внутренние API (REST)
- `POST /ref-links` (admin) — создать партнёрскую ссылку `{partner_id, percent, comment}` → `{ref_link_id, url}`
- `GET /partners/{id}/dashboard?period=...` — агрегаты.
- `POST /payouts` (partner) — создать заявку.
- `PATCH /payouts/{id}` (admin) — сменить статус.
- `GET /reports/partners?period=...` (admin) — сводка/CSV.

---

## 11. Модель данных (основные таблицы)
```
users(id, chat_id, role, referrer_type, referrer_id, ref_link_id, created_at)
roles(user_id, role)
referral_links(id, owner_id, link_type, percent, token, comment, created_at)
referrals(id, new_user_id, referrer_type, referrer_id, ref_link_id, created_at)
purchases(id, user_id, amount_minor, currency, is_first_for_user, created_at)
coin_bonus_ledger(id, giver_id, receiver_id, purchase_id, coins, status, created_at)
partner_commission_ledger(id, partner_id, user_id, purchase_id, ref_link_id, base_amount_minor, percent, commission_minor, status, reason, created_at)
partner_balances(partner_id, balance_minor, hold_minor, updated_at)
payout_requests(id, partner_id, amount_minor, status, requisites_json, created_at, processed_at)
audit_log(id, actor_id, action, entity, entity_id, payload_json, created_at)
report_cache(key, period_start, period_end, payload_json, generated_at)
```
Индексы по: `chat_id`, `ref_link_id`, `purchase_id`, `partner_id`, `created_at`.

---

## 12. Расчётные формулы и примеры
- `commission_minor = floor(base_amount_minor * percent / 100)` (или банковское округление — конфиг).
- Пример: покупка 1 000 ₽, percent=30 → комиссия 300 ₽.
- Первая покупка у «user→user»: обеим сторонам `+1 coin` → запись в `coin_bonus_ledger` (2 записи или одна с двусторонними полями — на усмотрение реализации).

---

## 13. Потоки состояний
### 13.1 Payout
`requested → approved → paid` или `requested → rejected`.

### 13.2 Commission entry
`accrued → (optional hold) → available → paid_out|reversed`.

---

## 14. Матрица прав (ACL)
- **user**: просмотр своей ссылки/баланса/истории бонусов.
- **partner**: всё как user + кабинет партнёра, запросы на выплаты/ссылки, просмотр статистики по своим ссылкам.
- **admin**: управление ролями, партнёрами, ссылками, отчётами, выплатами, ручные корректировки, изменение атрибуции (с записью в аудит).

---

## 15. Миграции и совместимость
- Миграция существующих пользователей: выдать всем **user**‑ссылку.
- Существующие покупки не участвуют в реферальной логике задним числом.
- Атрибуция назначается **только** при новом `start` с payload после релиза.

---

## 16. Тест‑кейс‑пакет (acceptance)
1) Регистрация по user‑ссылке → первая покупка → оба получают `+1 coin` (ровно 1 раз).
2) Регистрация по partner‑ссылке → любая покупка → партнёру начисляется комиссия по % ссылки.
3) Партнёр с 2 ссылками (20% и 40%) → новые юзеры по каждой → комиссии считаются с соответствующим %.
4) Возврат платежа → сторно комиссии и, если применимо, сторно бонус‑coins.
5) Партнёр запрашивает выплату суммы ≤ доступного баланса → админ `approved` → `paid` → баланс уменьшается.
6) Админ меняет роль user→partner → партнёрский кабинет доступен; создание ссылки работает.
7) Идемпотентность webhook оплаты: повторная доставка не увеличивает начисления.
8) Антифрод: само‑реферал помечается флагом; выплата недоступна до снятия флага.
9) Отчёты: ежедневный/еженедельный подтягивают корректные периоды и значения.

---

## 17. План внедрения
1) Схема БД и миграции.  
2) Генерация/валидация payload (HMAC).  
3) Атрибуция при /start.  
4) Логика начислений (coins, комиссии).  
5) Кабинет партнёра + админ‑панель.  
6) Выплаты и статусы.  
7) Отчёты и выгрузки.  
8) Антифрод и аудит.  
9) Нагрузочное и E2E‑тестирование.  
10) Релиз с флажком Feature Toggle.

---

## 18. Риски и мониторинг
- Неверная атрибуция при кросс‑кампаниях → строгая фиксация на момент регистрации.
- Повторная обработка платежей → idempotency.
- Диспуты по процентам → неизменяемость процента для уже зарегистрированных.
- Нагрузочные пики отчётов → кэширование/агрегации.

---

## 19. Приложение: форматы и примеры
### 19.1 Payload ссылки
```
{
  "t": "partner",      // user|partner
  "rid": 12345,         // владелец ссылки
  "lid": 67890,         // id конкретной ссылки
  "p": 30,              // % для partner‑ссылок
  "exp": 1735600000,    // unix, опционально
  "sig": "<HMAC>"
}
```

### 19.2 Пример CSV отчёта по партнёру
```
Дата;Регистрации;Оплаты;Сумма к зачёту;Комиссия;Бонус‑генерации рефералам
2025‑09‑20;12;5;12500,00;3750,00;7
...
```

